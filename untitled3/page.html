<!DOCTYPE html>
<html lang="en">
<style>
    .canvas {
        position: absolute;
        top: 128px;
        left: 8px;
        z-index: 10;
        background-color:rgba(255,0,0,0.5);
    }
    .container {
        height: 100%;
        width: 100%;
        display: flex;
    }
    .subcontainer {
        width: 50%;
    }

    .moodimg {
        width: 128px;
        height: 128px;
    }
    .slider {
        -webkit-appearance: none;
        width: 100%;
        height: 15px;
        border-radius: 5px;
        background: #d3d3d3;
        outline: none;
        opacity: 0.7;
        -webkit-transition: .2s;
        transition: opacity .2s;
    }

    .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 25px;
        height: 25px;
        border-radius: 50%;
        background: #4CAF50;
        cursor: pointer;
    }

    .slider::-moz-range-thumb {
        width: 25px;
        height: 25px;
        border-radius: 50%;
        background: #4CAF50;
        cursor: pointer;
    }
    .view{
        width: 100%;
        height: 15px;
    }

</style>

<head>
    <meta charset="UTF-8">
    <title>Welcome to the classroom labeling system</title>
    <div style="text-align:center" xmlns="">
        <h1>
            Welcome to the Classroom Video Labelling System!
        </h1>
    </div>
    <h2>Here is your video to annotate: </h2>
</head>


<body onload=resize_canvas()>
<div class="container" id = "container">
    <div id="left" class="subcontainer">
        <video class="video" id="vplayer"  oncontextmenu="return false;"
               src="http://www.rapconverter.com/SampleDownload/Sample1280.mp4" ontimeupdate="change_slider(this)">
        </video>
        <canvas class="canvas" id="myCanvas">
            Your browser does not support the HTML5 canvas tag.
        </canvas>
        <button id="drawbutton">Add an annotation </button>
        <button id="dltbutton">Add an annotation </button>
        <button id="playbutton" onclick="play_jquery()">
            Play/Pause Video
        </button>
        <button id="restartbutton" onclick="restart_video()">
            Restart!
        </button>
        <button id="rewindbutton" onclick="rewind_video()">
            Rewind!
        </button>
        <div id="bottom" class="subcontainer">
            <div class="slidecontainer" onchange="show_slider_value()">
                <input type="range" min="1" max="100" value="50" class="slider" id="myRange">
            </div>
            <button id="lastFrame" onclick="change_frame(false)">
                Last Frame!
            </button>
            <button id="nextFrame" onclick="change_frame(true)">
                Next Frame!
            </button>

            <view class = "view" id="demo" > 18</view>
            <br>
            <view id="debugtext">DEBUG</view>
        </div>
    </div>
    <div id="right" class="subcontainer">
        <img id="happy" src="https://themuslimtimesdotinfodotcom.files.wordpress.com/2013/09/happy-face.jpg?w=300"
             class="moodimg"></img>
        <br>
        <br>
        <img id="sad" src="https://i.ebayimg.com/images/g/~EwAAOxycGJSUJsx/s-l300.jpg"
             class="moodimg"></img>
        <br>
        <br>
        <input id="dbtxt" type="text">
        <button id="dbbutton" onclick="db_button()">
            Add an entry to the db!
        </button>
    </div>
</div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://sdk.amazonaws.com/js/aws-sdk-2.7.16.min.js"></script>
<script src="canvas-draw.js" type="text/javascript"></script>

<script>
    offsetX = 8;
    offsetY = 128;
    drawmode = false;

    // Authenticated DB IAM role: Cognito_ClassroomLabellingSystemAuth_Role
    // Unauthenticated DB IAM role: Cognito_ClassroomLabellingSystemUnauth_Role
    // identity pool id: "us-east-2:4d581a21-bd4a-4f91-a41e-30b8db3397e1"

    function show_slider_value() {
        var slider = document.getElementById("myRange");
        var output = document.getElementById("demo");
        var mediaElement =  $("#vplayer").get(0);
        var duration = mediaElement.duration;
        output.innerHTML = parseFloat(slider.value/100 * duration).toPrecision(3)+":"+duration.toPrecision(3); // Display the default slider value
        // Update the current slider value (each time you drag the slider handle)
        slider.oninput = function() {
            var time = parseFloat(slider.value/100 * duration).toPrecision(3)
            output.innerHTML = time+":"+duration.toPrecision(3)
            mediaElement.currentTime = time
            mediaElement.pause()
            $("#vplayer").load()
        }
    }

    function play_jquery() {
        // $('#playbutton').click(function () {
            if (!$("#vplayer").get(0).paused) {
                $("#vplayer").get(0).pause();
            } else {
                $("#vplayer").get(0).play();
            }
            $("#vplayer").load()
        // });
    }

    function change_frame(isNext){
        var cTime = $("#vplayer").get(0).currentTime;
        var duration = $("#vplayer").get(0).duration;
        var changed_time;
        if(isNext){
            changed_time = cTime+5;
        }else{
            changed_time = cTime-5;
        }

        if(changed_time>duration){
            changed_time = duration;
        }
        if(changed_time<0){
            changed_time = 0;
        }
        $("#vplayer").get(0).currentTime = changed_time
        $("#vplayer").load()

    }
    function restart_video(){
        // $('#restartbutton').click(function () {
            $("#vplayer").get(0).currentTime = 0.0
            $("#vplayer").get(0).play();
            $("#vplayer").load()
        // })
    }
    
    function rewind_video() {
        //Create a variable to manage video elements
        var mediaElement =  $("#vplayer").get(0);

        //Adjust playhead (currentTime) to 0 if elapsed time is less than 2 seconds else adjust it to the elapsed time minus 2 seconds
        if(mediaElement.currentTime < 2) {
            mediaElement.currentTime = 0;
        } else {
            mediaElement.currentTime = mediaElement.currentTime-2;
        }
        $("#vplayer").load()
    }
    function db_button() {
        AWS.config.region = 'us-east-2';
        AWS.config.credentials =
            new AWS.CognitoIdentityCredentials({IdentityPoolId: "us-east-2:4d581a21-bd4a-4f91-a41e-30b8db3397e1"});

        var db = new AWS.DynamoDB();
        $("#dbtxt").value = ""
    }

    function resize_canvas()
    {
        var element =  $("#vplayer").get(0);
        var w = element.offsetWidth;
        var h = element.offsetHeight;
        var top = element.style.top;
        var left = element.style.left;
        var cv = document.getElementById("myCanvas");
        cv.width = w;
        cv.height =h;
        cv.top = top;
        cv.left = left;
    }

    function change_slider(element){
        var time = $("#vplayer").get(0).currentTime;
        var duration = $("#vplayer").get(0).duration;
        var slider = document.getElementById("myRange");
        var output = document.getElementById("demo");
        var percentage = parseFloat(time/duration).toPrecision(3)*100
        slider.value = percentage;
        output.innerHTML = time.toPrecision(3)+":"+duration.toPrecision(3)
    }

    let canvas = $('#myCanvas').get(0)
    let drawbtn = $('#drawbutton').get(0)

    drawbtn.addEventListener('click', function(e) {
        if(drawmode == true){
            drawmode = false;
            document.getElementById('debugtext').innerHTML = "DRAW MODE OFF";
        } else {
            drawmode = true;
            canvas.style.cursor = "crosshair";
            document.getElementById('debugtext').innerHTML = "DRAW MODE ON";
        }
    });

    canvas.addEventListener('click', function(e) {
        if (drawmode == true) {
            const x = e.pageX - offsetX;
            const y = e.pageY - offsetY;
            document.getElementById('debugtext').innerHTML = "(" + x + ", " + y + ")";
            var context = canvas.getContext('2d');
            context.beginPath()
            context.rect(x, y, 30, 30)
            context.fillStyle = 'yellow';
            context.fill();
            context.lineWidth = 2;
            context.strokeStyle = 'black';
            context.stroke();
            canvas.style.cursor = "pointer"
            drawmode = false;
        }
    });


</script>
</body>
</html>